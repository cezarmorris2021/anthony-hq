<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Anthony2kold‚Äôs Creative HQ</title>

  <style>
    :root{
      --bg:#070b18; --card:#0f1730; --soft:#121d3d;
      --text:#e9eeff; --muted:#b8c6ff; --line:rgba(255,255,255,.08);
      --shadow:0 16px 50px rgba(0,0,0,.45);
      --r:18px; --a1:#60a5fa; --a2:#86efac;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    }
    body{margin:0;color:var(--text);background:radial-gradient(900px 500px at 12% 0%, #1a2a6a 0%, var(--bg) 55%);}
    .wrap{max-width:1100px;margin:auto;padding:18px}
    .card{background:rgba(15,23,48,.88);border:1px solid var(--line);border-radius:var(--r);padding:14px;box-shadow:var(--shadow);}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
    .col6{grid-column:span 6}
    .col12{grid-column:span 12}
    @media(max-width:850px){.col6{grid-column:span 12}}
    h1{margin:0;font-size:30px}
    h2{margin:0 0 8px;font-size:18px}
    .sub{color:var(--muted);margin:6px 0 0}
    .tiny{color:var(--muted);font-size:12px;line-height:1.45}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    button{
      background:rgba(134,239,172,.18);
      border:1px solid rgba(134,239,172,.28);
      color:var(--text);
      padding:8px 12px;border-radius:14px;font-weight:800;cursor:pointer
    }
    button.ghost{background:rgba(96,165,250,.14);border-color:rgba(96,165,250,.25)}
    button:disabled{opacity:.55;cursor:not-allowed}
    input,textarea{
      width:100%;background:rgba(18,29,61,.6);color:var(--text);
      border:1px solid rgba(255,255,255,.10);border-radius:14px;padding:10px;box-sizing:border-box;
    }
    .list{display:grid;gap:10px;margin-top:10px}
    .item{
      display:flex;justify-content:space-between;gap:10px;
      padding:10px;border-radius:14px;background:rgba(18,29,61,.55);
      border:1px solid rgba(255,255,255,.08)
    }
    .tag{font-size:12px;border:1px solid rgba(255,255,255,.12);padding:4px 8px;border-radius:999px;white-space:nowrap;color:var(--muted)}
    .progress{height:10px;background:rgba(255,255,255,.08);border-radius:999px;overflow:hidden}
    .bar{height:100%;width:0%;background:linear-gradient(90deg,var(--a1),var(--a2))}
    hr{border:0;border-top:1px solid var(--line);margin:14px 0}
    dialog{border:none;border-radius:18px;background:#0f1730;color:var(--text);max-width:560px}
    dialog::backdrop{background:rgba(0,0,0,.7)}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;}
  </style>
</head>

<body>
<div class="wrap">

  <div class="card col12">
    <h1>üéÆ Anthony2kold‚Äôs Creative HQ</h1>
    <p class="sub">Funny mode: ON. Brain: CRACKED. Controller: warmed up. üß†üî•</p>
    <p class="tiny">This is a fan-made companion site. Not affiliated with Epic Games/Fortnite.</p>
  </div>

  <div class="grid" style="margin-top:12px">

    <!-- STATS -->
    <div class="card col6">
      <h2>üìä Player Stats</h2>
      <div class="row">
        <div>XP: <b id="xp">0</b></div>
        <div>Tier: <b id="tier">1</b></div>
        <div>Rewards: <b id="rewardsCount">0</b></div>
      </div>
      <div class="progress" style="margin-top:10px"><div id="bar" class="bar"></div></div>
      <div class="tiny" id="progText" style="margin-top:8px">0 / 100 XP to next tier</div>
      <div class="row" style="margin-top:10px">
        <button class="ghost" id="resetBtn">Reset (Dad only)</button>
      </div>
    </div>

    <!-- HARD KNOCKS -->
    <div class="card col6">
      <h2>üß± Hard Knocks Mode</h2>
      <div class="tiny" id="knockText">‚Äî</div>
      <div class="row" style="margin-top:10px">
        <button id="claimKnockBtn">Claim +10 Grit XP</button>
        <span class="tiny">One claim per page load.</span>
      </div>
    </div>

    <!-- CREATIVE LAB -->
    <div class="card col6">
      <h2>üß© Creative Lab (Island Codes)</h2>
      <div class="tiny">Add your island codes here (update anytime). Example format: 1234-5678-9012</div>
      <div class="row" style="margin-top:10px">
        <input id="codeInput" placeholder="Island code (e.g., 1234-5678-9012)" />
        <button id="addCodeBtn">Add</button>
      </div>
      <div id="codes" class="list"></div>
    </div>

    <!-- BATTLE PASS -->
    <div class="card col6">
      <h2>üéÅ Battle Pass: Dad Edition</h2>
      <div class="tiny">Complete missions, earn XP, unlock rewards. (No grind, just vibes.)</div>
      <div id="missions" class="list"></div>
    </div>

    <!-- PUZZLES -->
    <div class="card col6">
      <h2>üß† Vault: Brain Teasers</h2>
      <div class="tiny">Solve puzzles to unlock rewards. If you rage quit, you owe Dad one ‚ÄúGG‚Äù.</div>
      <div id="puzzles" class="list"></div>
    </div>

    <!-- FACTS -->
    <div class="card col6">
      <h2>üß™ Science + World Facts</h2>
      <div class="item" style="align-items:flex-start">
        <div>
          <div style="font-weight:900">Today‚Äôs Fact</div>
          <div class="tiny" id="factText">Press ‚ÄúGive me a fact‚Äù.</div>
          <div class="tiny" id="factStatus" style="margin-top:6px">Explain it back to Dad to claim XP üòÑ</div>
        </div>
        <span class="tag">Science</span>
      </div>
      <div class="row" style="margin-top:10px">
        <button id="factBtn">Give me a fact</button>
        <button class="ghost" id="claimFactBtn" disabled>Claim +15 XP</button>
      </div>
    </div>

    <!-- REWARD VAULT -->
    <div class="card col6">
      <h2>üîê Reward Vault</h2>
      <div id="rewards" class="list"></div>
    </div>

    <!-- LIVE LEADERBOARD (FIREBASE) -->
    <div class="card col6">
      <h2>üèÜ Live Squad Leaderboard (Firebase)</h2>
      <div class="tiny">This is the ‚ÄúRoom Code‚Äù part. Everyone uses the same room code to share one live scoreboard.</div>

      <div class="row" style="margin-top:10px">
        <input id="roomInput" placeholder="Room code (example: ANTHONY-SQUAD)" />
        <button class="ghost" id="joinRoomBtn">Join Room</button>
      </div>

      <div class="tiny" id="fbStatus" style="margin-top:8px">Firebase status: Not connected yet.</div>
      <div id="leaderboard" class="list"></div>

      <hr>

      <div class="tiny">
        If it won‚Äôt connect, add your GitHub Pages domain to:
        <b>Firebase ‚Üí Authentication ‚Üí Settings ‚Üí Authorized domains</b>
      </div>
    </div>

    <!-- BACKUP SQUAD SHARE (NO BACKEND) -->
    <div class="card col6">
      <h2>ü§ù Squad Share (Backup ‚Äî No Firebase)</h2>
      <div class="tiny">Export a code and send it in text/Discord. Import codes to compare.</div>

      <div class="row" style="margin-top:10px">
        <button id="exportBtn">Export</button>
        <button class="ghost" id="copyExportBtn" disabled>Copy</button>
      </div>
      <textarea id="exportBox" class="mono" rows="3" readonly placeholder="(Click Export)"></textarea>

      <div class="row" style="margin-top:10px">
        <input id="importName" placeholder="Name (Nephew / Friend)" />
        <button class="ghost" id="importBtn">Import</button>
      </div>
      <textarea id="importBox" class="mono" rows="3" placeholder="Paste their exported code here..."></textarea>
      <div id="squadBoard" class="list"></div>
    </div>

  </div>
</div>

<dialog id="modal">
  <div style="padding:14px 14px 0;font-weight:900" id="mTitle">Unlocked!</div>
  <div style="padding:10px 14px;color:var(--muted);line-height:1.55" id="mBody"></div>
  <div style="padding:0 14px 14px;display:flex;justify-content:flex-end;gap:10px">
    <button id="mOk">GG ‚úÖ</button>
  </div>
</dialog>

<script type="module">
  // =========================
  // CUSTOMIZE (optional)
  // =========================
  const PLAYER_NAME = "Anthony2kold";
  const STORAGE_KEY = "anthony2kold_creative_hq_v2";

  // =========================
  // FIREBASE CONFIG (yours)
  // NOTE: storageBucket set to .appspot.com for best compatibility
  // =========================
  const firebaseConfig = {
    apiKey: "AIzaSyBq-xu-v3zbA2QkFf1aHjUthdo4XljAV7k",
    authDomain: "anthony-0327.firebaseapp.com",
    projectId: "anthony-0327",
    storageBucket: "anthony-0327.appspot.com",
    messagingSenderId: "861566800264",
    appId: "1:861566800264:web:a91653b8be81e26e4aea3d",
    measurementId: "G-6EV7R63NWY"
  };

  // Firebase (web CDN modules)
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import {
    getFirestore, doc, setDoc, collection, onSnapshot
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  // =========================
  // UTIL / STATE
  // =========================
  const XP_TIER = 100;
  const $ = (id) => document.getElementById(id);

  const state = JSON.parse(localStorage.getItem(STORAGE_KEY)) || {
    xp: 0,
    missions: {},
    puzzles: {},
    rewards: [],
    gritClaimed: false
  };

  const codesKey = STORAGE_KEY + "_codes";
  const squadKey = STORAGE_KEY + "_squadboard";

  const clientIdKey = STORAGE_KEY + "_clientId";
  const clientId = localStorage.getItem(clientIdKey) || crypto.randomUUID();
  localStorage.setItem(clientIdKey, clientId);

  const squadBoard = JSON.parse(localStorage.getItem(squadKey) || "[]");

  function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }

  function tier(){ return Math.floor(state.xp / XP_TIER) + 1; }
  function prog(){ return state.xp % XP_TIER; }

  // Modal
  const modal = $("modal");
  $("mOk").onclick = () => modal.close();
  function popup(title, body){
    $("mTitle").textContent = title;
    $("mBody").textContent = body;
    modal.showModal();
  }

  // =========================
  // XP + Rewards
  // =========================
  const tierRewards = [
    { tier: 2, text: "üéÆ Reward: 1 hour gaming together (your choice)." },
    { tier: 3, text: "üçï Reward: Late-night snack (Dad approves the options üòÖ)." },
    { tier: 4, text: "üß± Reward: Build a new Creative map idea together." }
  ];

  function unlockReward(text){
    if (state.rewards.includes(text)) return;
    state.rewards.push(text);
    save();
    renderRewards();
    popup("üéÅ Reward Unlocked!", text);
    pushFirebase();
  }

  function checkTierRewards(){
    tierRewards.forEach(r => { if (tier() >= r.tier) unlockReward(r.text); });
  }

  function addXP(x, why){
    state.xp += x;
    save();
    render();
    popup("XP Gained üí•", `${why} (+${x} XP)`);
    checkTierRewards();
    pushFirebase();
  }

  // =========================
  // HARD KNOCKS
  // =========================
  const knocks = [
    "Hard knocks taught you what easy never could. ‚úÖ",
    "Built different. Still humble. Still smart. üò§",
    "Grit is the real meta.",
    "You don‚Äôt need luck ‚Äî you‚Äôve got discipline.",
    "Quiet confidence. Loud results."
  ];
  $("knockText").textContent = knocks[Math.floor(Math.random()*knocks.length)];
  $("claimKnockBtn").onclick = () => {
    if (state.gritClaimed) return popup("Nice try üòà", "Hard Knocks claim already used this load.");
    state.gritClaimed = true;
    save();
    addXP(10, "üß± Hard Knocks");
  };

  // =========================
  // MISSIONS
  // =========================
  const missionsData = [
    {id:"m1", name:"üìö Straight-A Sweep", xp:40, desc:"Do school work like a boss. (No cap.)"},
    {id:"m2", name:"üßπ House Clean Carry", xp:25, desc:"Help around the house. This is the real endgame."},
    {id:"m3", name:"üö∂ IRL Warm-Up", xp:20, desc:"Move your body today. Even 15 minutes counts."},
    {id:"m4", name:"üéÆ Creative Builder", xp:35, desc:"Build or improve one Creative map idea."},
    {id:"m5", name:"üß™ Science Flex", xp:30, desc:"Learn 1 science fact and explain it back."},
    {id:"m6", name:"üåç World Smart Check", xp:25, desc:"Teach 1 world fact (country/capital/event)." }
  ];

  function renderMissions(){
    const box = $("missions");
    box.innerHTML = "";
    missionsData.forEach(m => {
      const done = !!state.missions[m.id];
      const el = document.createElement("div");
      el.className = "item";
      el.innerHTML = `
        <div style="flex:1">
          <div style="font-weight:900">${m.name} <span class="tiny">(+${m.xp} XP)</span></div>
          <div class="tiny" style="margin-top:4px">${m.desc}</div>
        </div>
        <div class="row">
          <span class="tag">${done ? "Done ‚úÖ" : "Ready"}</span>
          <button ${done ? "disabled" : ""}>${done ? "‚úÖ" : "Complete"}</button>
        </div>
      `;
      el.querySelector("button").onclick = () => {
        state.missions[m.id] = true;
        save();
        addXP(m.xp, m.name);
        renderMissions();
      };
      box.appendChild(el);
    });
  }

  // =========================
  // PUZZLES
  // =========================
  const puzzlesData = [
    {id:"p1", name:"üî¢ Pattern Check", q:"What number completes the sequence: 2, 6, 12, 20, 30, __ ?", hint:"Look at the differences.", a:"42", xp:40, reward:"üéÅ Reward: Pick tonight‚Äôs snack combo."},
    {id:"p2", name:"üîê Caesar Shift", q:"Decode this (shift -3): DQWKRQB", hint:"A=1‚Ä¶ or think letters back 3.", a:"anthony", xp:50, reward:"üéÅ Reward: You choose dinner (1 night)."},
    {id:"p3", name:"üßä House Quest (optional)", q:"Riddle: ‚ÄúI‚Äôm cold inside but I‚Äôm not the freezer. I keep your quick wins.‚Äù Where is it?", hint:"Kitchen vibes.", a:"fridge", xp:35, reward:"üéÅ Reward: 1 hour Creative Lab time together."},
    {id:"p4", name:"üß† Logic Trap", q:"Bat+ball $1.10 total. Bat $1.00 more. Ball cost?", hint:"Not 0.10.", a:"0.05", xp:50, reward:"üîì Vault unlock: Dad drops a secret code."}
  ];

  function renderPuzzles(){
    const box = $("puzzles");
    box.innerHTML = "";
    puzzlesData.forEach(p => {
      const solved = !!state.puzzles[p.id];
      const el = document.createElement("div");
      el.className = "item";
      el.innerHTML = `
        <div style="flex:1">
          <div style="font-weight:900">${p.name} <span class="tiny">(+${p.xp} XP)</span></div>
          <div class="tiny" style="margin-top:6px">${p.q}</div>
          <div class="tiny" style="margin-top:6px"><b>Hint:</b> ${p.hint}</div>
          <div class="row" style="margin-top:8px">
            <input ${solved ? "disabled" : ""} placeholder="Answer..." />
            <button ${solved ? "disabled" : ""}>${solved ? "Solved ‚úÖ" : "Check"}</button>
          </div>
        </div>
        <span class="tag">${solved ? "Unlocked" : "Locked"}</span>
      `;
      el.querySelector("button").onclick = () => {
        const guess = (el.querySelector("input").value || "").trim().toLowerCase();
        if (!guess) return popup("Hold up", "Type an answer first üò≠");
        if (guess === p.a){
          state.puzzles[p.id] = true;
          save();
          addXP(p.xp, p.name);
          unlockReward(p.reward);
          renderPuzzles();
        } else {
          popup("‚ùå Not quite", "Close‚Ä¶ but not cracked yet. Try again.");
        }
      };
      box.appendChild(el);
    });
  }

  // =========================
  // FACTS
  // =========================
  const facts = [
    "A day on Venus is longer than a year on Venus.",
    "Neutron stars are so dense a teaspoon could weigh billions of tons on Earth.",
    "Antarctica is the world‚Äôs largest desert by precipitation.",
    "Your brain uses roughly 20% of your body‚Äôs energy at rest.",
    "Saturn would float in water (if the tub was big enough).",
    "Tectonic plates move about as fast as fingernails grow."
  ];
  let lastFactIndex = null;
  let factClaimed = true;

  $("factBtn").onclick = () => {
    let idx = Math.floor(Math.random()*facts.length);
    if (lastFactIndex !== null && facts.length > 1) while (idx === lastFactIndex) idx = Math.floor(Math.random()*facts.length);
    lastFactIndex = idx;
    factClaimed = false;
    $("factText").textContent = facts[idx];
    $("factStatus").textContent = "Explain it back to Dad to claim XP üòÑ";
    $("claimFactBtn").disabled = false;
  };

  $("claimFactBtn").onclick = () => {
    if (factClaimed) return;
    factClaimed = true;
    $("claimFactBtn").disabled = true;
    $("factStatus").textContent = "XP claimed. Certified cracked. ‚úÖ";
    addXP(15, "üß™ Science Fact Explainer");
  };

  // =========================
  // CREATIVE CODES
  // =========================
  function renderCodes(){
    const box = $("codes");
    const codes = JSON.parse(localStorage.getItem(codesKey) || "[]");
    box.innerHTML = "";
    if (!codes.length){
      box.innerHTML = `<div class="item"><div class="tiny">No island codes yet. Add one when ready.</div><span class="tag">Creative</span></div>`;
      return;
    }
    codes.forEach((c, idx) => {
      const el = document.createElement("div");
      el.className = "item";
      el.innerHTML = `
        <div>
          <div style="font-weight:900">Island Code</div>
          <div class="tiny">${c}</div>
        </div>
        <div class="row">
          <button class="ghost">Copy</button>
          <button>Remove</button>
        </div>
      `;
      el.querySelector(".ghost").onclick = async () => {
        try { await navigator.clipboard.writeText(c); } catch {}
        popup("Copied ‚úÖ", "Island code copied.");
      };
      el.querySelector("button:not(.ghost)").onclick = () => {
        codes.splice(idx,1);
        localStorage.setItem(codesKey, JSON.stringify(codes));
        renderCodes();
      };
      box.appendChild(el);
    });
  }

  $("addCodeBtn").onclick = () => {
    const v = $("codeInput").value.trim();
    if (!v) return popup("Hold up", "Enter an island code first.");
    const codes = JSON.parse(localStorage.getItem(codesKey) || "[]");
    codes.unshift(v);
    localStorage.setItem(codesKey, JSON.stringify(codes));
    $("codeInput").value = "";
    renderCodes();
  };

  // =========================
  // REWARDS UI
  // =========================
  function renderRewards(){
    const box = $("rewards");
    box.innerHTML = "";
    if (!state.rewards.length){
      box.innerHTML = `<div class="item"><div class="tiny">No rewards yet. Get cracked. üß†</div><span class="tag">Locked</span></div>`;
      return;
    }
    state.rewards.forEach(r => {
      const el = document.createElement("div");
      el.className = "item";
      el.innerHTML = `<div style="font-weight:900">${r}</div><span class="tag">Unlocked</span>`;
      box.appendChild(el);
    });
  }

  // =========================
  // BACKUP SQUAD EXPORT/IMPORT (no backend)
  // =========================
  function toSquadPayload(){
    return {
      name: PLAYER_NAME,
      xp: state.xp,
      tier: tier(),
      rewards: state.rewards.length,
      missionsDone: Object.keys(state.missions).length,
      puzzlesSolved: Object.keys(state.puzzles).length,
      ts: Date.now()
    };
  }
  function encodePayload(obj){
    const json = JSON.stringify(obj);
    return btoa(unescape(encodeURIComponent(json)));
  }
  function decodePayload(code){
    const json = decodeURIComponent(escape(atob(code.trim())));
    return JSON.parse(json);
  }
  function renderSquadBoard(){
    const box = $("squadBoard");
    box.innerHTML = "";
    const list = [...squadBoard].sort((a,b)=> (b.xp||0)-(a.xp||0));
    if (!list.length){
      box.innerHTML = `<div class="item"><div class="tiny">No squad mates imported yet.</div><span class="tag">Squad</span></div>`;
      return;
    }
    list.forEach(m=>{
      const el = document.createElement("div");
      el.className = "item";
      el.innerHTML = `
        <div>
          <div style="font-weight:900">${m.label || m.name || "Squadmate"}</div>
          <div class="tiny">XP: <b>${m.xp}</b> ‚Ä¢ Tier: <b>${m.tier}</b> ‚Ä¢ Rewards: <b>${m.rewards}</b></div>
          <div class="tiny">Missions: ${m.missionsDone} ‚Ä¢ Puzzles: ${m.puzzlesSolved}</div>
        </div>
        <span class="tag">${(m.xp||0) >= state.xp ? "Ahead üèÅ" : "Behind üòà"}</span>
      `;
      box.appendChild(el);
    });
  }

  $("exportBtn").onclick = () => {
    const code = encodePayload(toSquadPayload());
    $("exportBox").value = code;
    $("copyExportBtn").disabled = false;
    popup("‚úÖ Export Ready", "Copy and send this code to your squad.");
  };

  $("copyExportBtn").onclick = async () => {
    const code = $("exportBox").value.trim();
    if (!code) return;
    try { await navigator.clipboard.writeText(code); } catch {}
    popup("Copied ‚úÖ", "Squad code copied.");
  };

  $("importBtn").onclick = () => {
    const code = $("importBox").value.trim();
    if (!code) return popup("Hold up", "Paste a squad code first.");
    let payload;
    try { payload = decodePayload(code); } catch { return popup("‚ùå Invalid code", "Make sure it copied fully."); }
    const label = $("importName").value.trim() || payload.name || "Squadmate";
    const entry = { ...payload, label };
    const i = squadBoard.findIndex(x=>x.label===label);
    if (i>=0) squadBoard[i]=entry; else squadBoard.push(entry);
    localStorage.setItem(squadKey, JSON.stringify(squadBoard));
    renderSquadBoard();
    popup("ü§ù Imported!", `${label} added to squad board.`);
  };// =========================
  // RESET
  // =========================
  $("resetBtn").onclick = () => {
    if (!confirm("Reset XP, missions, puzzles, rewards?")) return;
    localStorage.removeItem(STORAGE_KEY);
    state.xp=0; state.missions={}; state.puzzles={}; state.rewards=[]; state.gritClaimed=false;
    save();
    render();
    popup("Reset ‚úÖ","Fresh drop.");
    pushFirebase();
  };

  // =========================
  // RENDER
  // =========================
  function render(){
    $("xp").textContent = state.xp;
    $("tier").textContent = tier();
    $("rewardsCount").textContent = state.rewards.length;
    $("bar").style.width = (prog()/XP_TIER*100) + "%";
    $("progText").textContent = `${prog()} / ${XP_TIER} XP to next tier`;
    renderCodes();// =========================
  // RENDER
  // =========================
  function render(){
    $("xp").textContent = state.xp;
    $("tier").textContent = tier();
    $("rewardsCount").textContent = state.rewards.length;
    $("bar").style.width = (prog()/XP_TIER*100) + "%";
    $("progText").textContent = `${prog()} / ${XP_TIER} XP to next tier`;
    renderCodes();
    renderMissions();
    renderPuzzles();
    renderRewards();
    renderSquadBoard();
    checkTierRewards();
  }// =========================
  // FIREBASE: LIVE LEADERBOARD
  // =========================
  let fb = { app:null, auth:null, db:null, user:null, roomId:null, unsub:null };
  try{
    fb.app = initializeApp(firebaseConfig);
    fb.auth = getAuth(fb.app);
    fb.db = getFirestore(fb.app);

    const cred = await signInAnonymously(fb.auth);
    fb.user = cred.user;
    $("fbStatus").textContent = "Firebase status: Connected ‚úÖ (anonymous)";
  }catch(e){
    console.error(e);
    $("fbStatus").textContent = "Firebase status: NOT connected ‚ùå (check Auth/Firestore/Authorized domains)";
  }
    function playerPayload(){
    return {
      name: PLAYER_NAME,
      xp: state.xp,
      tier: tier(),
      rewards: state.rewards.length,
      missionsDone: Object.keys(state.missions).length,
      puzzlesSolved: Object.keys(state.puzzles).length,
      updatedAt: Date.now()
    };
  }

  let pushTimer = null;
  async function pushFirebaseNow(){
    if (!fb.db || !fb.user || !fb.roomId) return;
    const ref = doc(fb.db, "rooms", fb.roomId, "players", clientId);
    await setDoc(ref, playerPayload(), { merge:true });
  }function pushFirebase(){
    if (!fb.db || !fb.user || !fb.roomId) return;
    if (pushTimer) clearTimeout(pushTimer);
    pushTimer = setTimeout(() => { pushFirebaseNow().catch(console.error); }, 250);
  }

  function renderLeaderboard(rows){
    const box = $("leaderboard");
    box.innerHTML = "";
    if (!rows.length){
      box.innerHTML = `<div class="item"><div class="tiny">No players yet. Join a room, then you‚Äôll appear.</div><span class="tag">Live</span></div>`;
      return;
    }
    rows.forEach((p, idx) => {
      const el = document.createElement("div");
      el.className = "item";
      const me = (p.id === clientId);
      el.innerHTML = `
        <div><div style="font-weight:900">${idx+1}. ${p.name || "Player"} ${me ? "(you)" : ""}</div>
          <div class="tiny">XP: <b>${p.xp||0}</b> ‚Ä¢ Tier: <b>${p.tier||1}</b> ‚Ä¢ Rewards: <b>${p.rewards||0}</b></div>
        </div>
        <span class="tag">${me ? "ME ‚úÖ" : "LIVE"}</span>
      `;
      box.appendChild(el);
    });
  }

  function joinRoom(roomIdRaw){
    if (!fb.db || !fb.user){
      return popup("Firebase not ready", "Fix Firebase first: enable Anonymous Auth + create Firestore + add Authorized domain.");
    }
    const roomId = (roomIdRaw || "").trim().toUpperCase();
    if (!roomId) return popup("Room code", "Type a room code first.");
    fb.roomId = roomId;

    // stop previous listener
    if (fb.unsub) fb.unsub();const playersCol = collection(fb.db, "rooms", fb.roomId, "players");
    fb.unsub = onSnapshot(playersCol, (snap) => {
      const rows = [];
      snap.forEach(d => rows.push({ id:d.id, ...d.data() }));
      rows.sort((a,b)=> (b.xp||0)-(a.xp||0));
      $("fbStatus").textContent = `Firebase status: Room ${fb.roomId} (live) ‚úÖ`;
      renderLeaderboard(rows);
    }, (err) => {
      console.error(err);
      $("fbStatus").textContent = "Firebase status: Room listen failed ‚ùå (check Firestore rules / auth)";
    });

    pushFirebase();
  }

  $("joinRoomBtn").onclick = () => joinRoom($("roomInput").value);

  // Boot
  render();

</script>
</body>
</html>
